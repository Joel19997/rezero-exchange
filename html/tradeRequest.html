<?php
    session_start();
    
    //require_once("protect.php"); //redirect to log in page since this is for logged in users to list
?> 

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" ng-href="https://mdbootstrap.com\docs\standard\data\tables\"target="_blank">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <!-- CSS -->
    
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <script src="https://use.fontawesome.com/a64b47fd82.js"></script>
        
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    
    <!-- jQuery and JS bundle w/ Popper.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/testHome.css">
    <link rel="stylesheet" href="css/homeresponsive.css">
    <link rel="stylesheet" href="css/createListing.css">
        <style>
            .table th, .table td { 
                                    border-top: none !important; 
                                }
            tr:nth-child(even) {
                background-color:rgb(201, 99, 99);
            }
        </style>
    

</head>

<body class="body1" onload='getData()'>
    
    <body onload="">
      <nav class="navbar navbar-expand-lg navbar-light bg-light" id="test1">
        <a class="navbar-brand" href="#">Re-Zero</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon" style="color: white;"></span>
        </button>
        <div class="collapse navbar-collapse " id="navbarNav">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item active">
              <button type="button" class="btn btn-linkNav" style="margin-top: 15px; padding-top:12px;" onclick="toggleSearch()"></button>
            </li>
            <li class="nav-item active">
              <a class="nav-link" href="testHome.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Browse</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">About</a>
            </li>
        <?php 
          //Displays different buttons depending on user session status (whether user is logged in or not)
          if ( !isset($_SESSION["user"]) ) {
            echo "
            <li class='nav-item'>
              <a class='nav-link' href='loginPage.html' id='login'>Log In</a>
            </li>
            <li class='nav-item'>
              <a class='nav-link' href='registerPage.html' id='signup'>Sign Up</a>
            </li>
            ";
          }
          else{
            echo "
            <li class='nav-item'>
              <a class='nav-link' href='logout.php' id='login'>Log Out</a>
            </li>
            ";
          }
        ?>
  
            
          </ul>
        </div>
      </nav>
      
      <!-- SearchBar -->
      <section id="searchBar" class="search-bar" style = 'margin-top:-20px'>
        <div class="container">
          <div class="row">
            <div class="col-lg-10 mx-auto">
              <form action="registerPage.html" method="GET">
                <div class="p-1 bg-light shadow-sm">
                  <form method="POST">
                  <div class="input-group">
                    <input type="search" placeholder="Search based on title, genre, author" class="form-control border-0 bg-light">
                    <div class="input-group-append">
                      <!-- Button -->
                      <div class="btn-group">
                        <button type="button" class="btn btn-secondary dropdown-toggle smallscreen" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                          Title
                        </button>
                        <div class="dropdown-menu">
                          <option class="dropdown-item" href="#" selected>Title</option>
                          <option class="dropdown-item" href="#">Author</option>
                          <option class="dropdown-item" href="#">Genre</option>
                        </div>
                      </div>
                      <div class="input-group-append">
                        <button type="submit" class="btn btn-link"><a class="searchIcon"></a></button>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </section>
      
        <style>

            
            .table th, .table td { 
                border-top: none !important; 
                }
            tr:nth-child(even) {background-color: #704148;}

        </style>
    </header>

    
    </div>
    <body class ='body1'>
    
    <div class="overlay" id = 'listing' style = 'margin-top:250px'>
        <div class = "container-fluid" id='resultStatus' style='margin-bottom:-8px;'></div>
        <div id='displayTable'></div>
        <!-- <div class="container">
                <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.</p>
            </div> -->
    </div>
</body>
    
    <div class="modal hide fade" id="modalTrade">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header "style = 'background-color:green;color:white'>
                    <h5 class="modal-title mx-auto" id="error">Trade Success</h5>
                    <button type="button" class="close ml-0 pl-0" data-dismiss="modal" aria-label="Close"onclick = 'modalAccept()'>
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <p>You have accepted the trade!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal" onclick = 'modalAccept()'>Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal hide fade" id="modalReject">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content" >
                <div class="modal-header "style = 'background-color:red;color:white'>
                    <h5 class="modal-title mx-auto" id="error">Trade rejected</h5>
                    <button type="button" class="close ml-0 pl-0" data-dismiss="modal" aria-label="Close" onclick = 'modalReject()'>
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <p>You have rejected the trade!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal" onclick = 'modalReject()'>Close</button>
                </div>
            </div>
        </div>
    </div>
    
        <div class="modal fade" id="booksInformation" tabindex="-1" role="dialog" aria-labelledby="booksInformation" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modal-title"><p id = 'mod-title'></p></h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close"onclick = 'removeData()'>
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                                <div class = "row">
                                    <div class ="col-sm-6" id ='modal-image'>

                                    </div>
                                    <div class = "col-sm-6" id = 'modal-desc'>

                                    </div>
                                </div>
                                <div class = "row">
                                    <div class ="col-sm-12" id ='modal-info'>

                                    </div>
                                </div>
                                

                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div id = 'readMore'></div>
                </div>
              </div>
            </div>
      
        
    </body>
    
  


    <script type="text/javascript">
        window.addEventListener("scroll", function () {
            var header = document.querySelector("header");
            header.classList.toggle("sticky", window.scrollY > 0);
        })

    </script>
    <?php 
    //Displays different buttons depending on user session status (whether user is logged in or not)
    if ( !isset($_SESSION["user"]) ) {
      header("location: loginPage.html");
      
    }
    else{
        $val = $_SESSION["user"];
    }
    
  ?>

    <script>
        //Call to populate data on load
        //$username = $_SESSION['username'];
        //$book_id = $_POST['bookID'];// get post value from previous page
        var img = '';
        function getData() {
            let username = "<?php echo $val?>";
            let output = '<div class = "container-sm-fluid" ><table class="table table-condensed table-responsive-sm" id = "myTable" style ="color:white;background-color:#463f3a">';
            var request = new XMLHttpRequest();
            let count =1
            request.onreadystatechange = function () {

                if (this.readyState == 4 && this.status == 200) {

                    let myList = JSON.parse(this.responseText);
                    if (myList['trades'].length == 0) {
                        document.getElementById('resultStatus').innerHTML = '<h1>You do not have any trade request at the moment<h1>';
                    }
                    else {
                        
                        document.getElementById('resultStatus').innerHTML = '<h2 style = "margin-bottom:-40px">You have ' + myList['trades'].length + ' listings to choose from:<h2>';
                       
                        output += '<thead><tr>';
                        output += '<th scope="col"><h4>#</h4></th>';
                        output += '<th scope="col" style = max-width: 200px><h4>User</h4></th>';
                        output += '<th scope="col"><h4>Would like to trade</h4></th>';
                        output += '<th scope="col"><h4>For your book</h4></th>';
                        output += '<th scope="col" style="margin-left:20px"><h4>Action</h4></th></tr></thead><tbody class = "panel">';
                        let idArr =[];
                        for (var i = 0; i < myList['trades'].length; i++) {
                            
                            idArr.push(getBookBylid(myList['trades'][i]['s_lid'], i));
                            idArr.push(getBookBylid(myList['trades'][i]['f_lid'], i));
                            //main row of table
                            output += '<tr  data-toggle="collapse" data-target="#demo' + i + '" data-parent="#myTable"><td class="expand-button">'+count+'</td>';
                            let myBook = 'myBook'+i;
                            count +=1
                            output += '<td scope="col" ><p id = "username' + i + '" style ="margin:10px 0px 20px 0px"></p></td>';
                            output += '<td scope="col"> <p id = "hisBook' + i + '"></p><button type="button" class="btn btn-info" data-toggle="modal" data-target="#booksInformation" onclick = "generateModal(' + i + ',' + myList['trades'][i]['s_lid'] + ')">Book info</button></td> ';
                            output += '<td scope="col" style = "max-width:200px"> <p id = "' + myBook+ '"></p><button type="button" class="btn btn-info" data-toggle="modal" data-target="#booksInformation" onclick = "generateModal(' + i + ',' + myList['trades'][i]['f_lid'] + ')">Book info</button></td>';
                            temp = [];
                            temp = myList['trades'][i]['s_lid'];
                            output += '<td scope="col"><button type = "button" class = "btn bg-success" style ="color:white ;display: flex;margin-top:10px" onclick = "formTrade('+myList['trades'][i]['s_lid']+','+myList['trades'][i]['f_lid']+')">Accept</button><button type = "button" class = "btn bg-danger" style ="color:white; margin-top:20px"onclick = "rejectTrade('+myList['trades'][i]['s_lid']+','+myList['trades'][i]['f_lid']+')">Reject</button></td></tr>';
                            //output+= '<tr id="demo'+i+'" class="collapse"><td colspan="2" class="hiddenRow"><p id = "userDescription'+i+'" style =margin-left:80px ></p><td></td><td></td><td></td></tr>';
                            getUserParticulars(myList['trades'][i]['s_email'], i);
                            getBookBylid( myList['trades'][i]['f_lid'],i);
                            getBookBylid2(myList['trades'][i]['s_lid'],i);
                           
                            
                        }

                            // populate with owner first +last name, email, contact and tele
                        
                        output += '</tbody></table></div>';

                        

                        document.getElementById('displayTable').innerHTML = output;
                    }
                }

            }
            let url = 'database/tradeRequest.php';
            request.open("POST", url, true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.send("username=" + username);
           
        };
        

        function generateModal(i, book_id) {
            $('#booksInformation').modal('toggle');

            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    //console.log(this.responseText);
                    let data = JSON.parse(this.responseText);
                   // console.log('this->' + data['listing'][0]['title']);
                    let title = data['title'];
                    
                    let display = document.getElementById('mod-title');
                   // console.log('get'+title);
                    display.innerHTML = title;
                    let desc = '';
                    let isbn = data['isbn'];
                    let author = data['author'];
                    let description = data['description'];
                    //let description = data['listing'][0]['description'];
                    document.getElementById('modal-desc').innerHTML = '<p><b>ISBN: </b> '+isbn+'</p></br><p><b>Author: </b>'+author+'</p>';
                    //document.getElementById('modal-info').innerHTML ='<b>Sypnosis</b><p>'+description+'</p>';
                    //document.getElementsByClassName('modal-footer')[0]= '<tr id="demo'+i+'" class="collapse"><td colspan="2" class="hiddenRow"><div id = "'+img+'"></div> </td><td colspan="2" class="hiddenRow"><div id = "'+desc+'"> Sypnosis</div> </br><button class = "btn btn-info" onclick="readSettings('+i+')" id="'+read+'">Read more</button></td></tr>';
                    if (description.length == 0) {
                        document.getElementById('modal-info').innerHTML = 'No description';
                    }
                    else {
                        document.getElementById('modal-info').innerHTML = '<b>Sypnosis</b></br><p style=text-align:justify;>' + description.slice(0, 300) + '<span id="dots">...</span><span id="more" style = "display: none">' + description.slice(300, description.length) + '</span></p>';
                    }
                    document.getElementById('readMore').innerHTML = ' <button class = "btn btn-info" onclick="readSettings()" id="read">Read more</button></td>';

                    getBookDataForModal(isbn);
                
                    
                }
            }
            request.open("GET", 'database/getListingByID.php?id='+book_id, true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.send();
        }
        function getBookDataForModal(isbn) {

            var request = new XMLHttpRequest();
            let image = '';
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var data = JSON.parse(this.responseText).items[0].volumeInfo;
                    image = data.imageLinks.thumbnail;
                    let description = data.description;
                    document.getElementById('modal-image').innerHTML = '<img src=' + image + 'style="height: 300px; margin-left:50px"  >';
                    
                }
            }
            request.open("GET", `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`, true);
            request.send();
        }

        function modalAccept(){
            location.reload();
        }
        function modalReject(){
            location.reload();
        }

        function getUserParticulars(email, i) {
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                console.log(email);
                if (this.readyState == 4 && this.status == 200) {
                    let $userData = JSON.parse(this.responseText);
                    console.log($userData);
                    let $userInfo = 'Name: '+$userData['lastName'] + ' ';
                    $userInfo += $userData['firstName']+'</br>Contact No: '+$userData['contactNum']; 
                    $userInfo +='</br>Email: '+ $userData['email']+'</br>Telegram: @'+$userData['telegram']; 
                    document.getElementById('username'+i).innerHTML =$userInfo;
                    //$docEle = 'username' + i;
                    //console.log($docEle);
                
                }
            }
            let url = "database/getUserbyEmail.php?email="+email;
            request.open("GET", url, true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.send();


        }
        function formTrade(book_id,selected) {
            
            
            //$username = $_SESSION['username'];
            //$book_id = $_POST['bookID'];// get post value from previous page
            console.log('Options->',selected)
            //let username = "infinty@yahoo.com";
            //let book_id = 4;
            var request = new XMLHttpRequest();

            request.onreadystatechange = function () {
                
                if (this.readyState == 4 && this.status == 200) {
                    
                    $('#modalTrade').modal('toggle');
                }
            }
            let url = "database/completeTrade.php";
            request.open("POST", url, true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.send("&book_id=" + book_id + "&my_book_id=" + selected)
        }

        function rejectTrade(book_id,selected) {
            
            
            //$username = $_SESSION['username'];
            //$book_id = $_POST['bookID'];// get post value from previous page
            console.log('Options->',selected)
            //let username = "infinty@yahoo.com";
            //let book_id = 4;
            var request = new XMLHttpRequest();

            request.onreadystatechange = function () {
                console.log('request created');
                if (this.readyState == 4 && this.status == 200) {

                    console.log(this.responseText);
                    $('#modalReject').modal('toggle');
                }
            }
            let url = "database/rejectTrade.php";
            request.open("POST", url, true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.send("&book_id=" + book_id + "&my_book_id=" + selected)
        }
        function getBookBylid(book_id, i)//called By getData()
        {
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    //console.log(this.responseText);
                    let data = JSON.parse(this.responseText);
                    console.log('this->' + data['listing'][0]['title']);
                    let title = data['listing'][0]['title'];
                    document.getElementById('myBook' + i).innerHTML = '<p> Title: ' + data['listing'][0]['title'] + '</p></br><p style =margin-top:-30px> ISBN: ' + data['listing'][0]['isbn'] + '</P>';
                }
            }
            request.open("POST", 'database/getBookByLid.php', true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.send('book_id=' + book_id);
        }
        function getBookBylid2(book_id, i)//called By getData()
        {
            console.log('called', book_id);
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    //console.log(this.responseText);
                    let data = JSON.parse(this.responseText);
                    console.log('this->' + data['listing'][0]['title']);
                    let title = data['listing'][0]['title'];
                    document.getElementById('hisBook' + i).innerHTML = '<p> Title: ' + data['listing'][0]['title'] + '</p></br><p style =margin-top:-30px> ISBN: ' + data['listing'][0]['isbn'] + '</P>';
                }
            }
            request.open("POST", 'database/getBookByLid.php', true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.send('book_id=' + book_id);
        }

        function getBookFromApi(isbn, img, desc) {

            var request = new XMLHttpRequest();
            let image = '';
            request.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var data = JSON.parse(this.responseText).items[0].volumeInfo;
                    image = data.imageLinks.thumbnail;
                    console.log(data);
                    /*if(cb) cb(image);*/
                    let description = data.description;
                    console.log(description);
                    document.getElementById(img).innerHTML = '<img src=' + image + 'style="height: 300px; margin-left:50px"  >';
                    if (description.length == 0) {
                        document.getElementById(desc).innerHTML = 'No description';
                    }
                    else {
                        document.getElementById(desc).innerHTML = '<b>Sypnosis</b></br><p style=text-align:justify;>' + description.slice(0, 300) + '<span id="dots">...</span><span id="more" style = "display: none">' + description.slice(300, description.length) + '</span></p>';
                    }
                }
            }
            request.open("GET", `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`, true);
            request.send();

        }

        function readSettings() {
            var dots = document.getElementById("dots");
            var moreText = document.getElementById("more");
            var btnText = document.getElementById("read");
            if (dots.style.display === "none") {
                dots.style.display = "inline";
                btnText.innerHTML = "Read more";
                moreText.style.display = "none";

            } else {
                dots.style.display = "none";
                btnText.innerHTML = "Read less";
                moreText.style.display = "inline";

            }
        }


        function removeData()
        {
            document.getElementById('modal-image').innerHTML = '';
            document.getElementById('modal-desc').innerHTML = '';
            document.getElementById('modal-info').innerHTML = '';

        }

    
    </script>

<script src="js/homeui.js"></script>

</html>