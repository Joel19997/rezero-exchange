<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="testHome2.css">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap" rel="stylesheet"> 
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link rel="stylesheet" href="https://mdbootstrap.com/docs/standard/data/tables/"
        target="_blank">
        <!-- CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

        <!-- jQuery and JS bundle w/ Popper.js -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
        <style>
            .table th, .table td { 
                                    border-top: none !important; 
                                }
        </style>
    </head>
    <body class="body1" onload = 'getData()'>
        <header class="header1">
            <a href="testHome2.html" class="logo">Re-Zero</a>
            <ul>
                <li><a href="testHome2.html">Home</a></li>
                <li><a href="#">Books</a></li>
                <li><a href="#">About</a></li>
                <li class="login"><a href="loginPage.html" >Log In</a></li>
                
            </ul>
        </header>
        
        <div style='margin:50px;height:50px;'></div>
       
        <div class = 'container-fluid-sm'>
        <div class="overlay" style="background-color:#8f846f;position:relative;" >
            <div id = 'transactionMessage'></div>
            <div><span id = 'resultStatus' style='margin-top:20px'></span><button class = 'btn btn-danger' id ='createListing' style = 'position:absolute;right:20px;top:30px' onclick = 'createListing()'><nobr><span style = font-size:20px;font-weight:bold>+</span>  Add new listing </nobr></button></div>
            
            <div id = 'displayTable'></div>
           
        </div>
    </div>
    </body>



        <script type="text/javascript">
        window.addEventListener("scroll", function(){
            var header= document.querySelector("header");
            header.classList.toggle("sticky", window.scrollY > 0);
        })

    </script>
    <script>
        //Call to populate data on load
        //$username = $_SESSION['username'];
        //$book_id = $_POST['bookID'];// get post value from previous page
        var img = '';
        function getData(){
        username ="justinbieber@mail.com";
        book_id = 4;
        let output ='<div class = "container-sm-fluid" ><table class="table table-condensed table-responsive-sm" id = "myTable" style ="color:white " >';
        var request = new XMLHttpRequest();
        request.onreadystatechange = function()
        {
            
            if(this.readyState == 4 && this.status == 200)
            {
                let myList = JSON.parse(this.responseText);
                if(myList['listing'].length==0)
                {
                    document.getElementById('resultStatus').innerHTML = '<h2>You do not have any listings!<h2>';
                }
                else
                {
                    document.getElementById('resultStatus').innerHTML = '<h1 style="margin-bottom:-50px">Your current listings: <h1><br><h2 style = margin-bottom:-50px>You have currently '+myList['listing'].length+' book listed for trade<h2>';
                let counter =1;
                output +='<thead><tr style ="background-color:#463f3a">';
                output+='<th scope="col" >#</th>';
                output+='<th scope="col" style ="max-width:100px"><h4>Image</h4></th>';
                output+='<th scope="col" style ="max-width:200px"><h4>Book</h4></th>';
                output+='</thead><tbody class = "panel">';
                for( var i=0;i<myList['listing'].length;i++)
                {
                    //main row of table
                    count = i+1;
                    output+='<tr data-toggle="collapse" data-target="#data'+i+'" style = "background-color:#463f3a" data-parent="#myTable"><td class="expand-button">'+count+'</td>';
                    output+='<td scope="col" id = "main_image'+i+'"></td>';
                    output+='<td scope="col"><h3>'+myList['listing'][i]['title']+'</h3></br><p style = "margin-top:-30px"> ISBN: '+myList['listing'][i]['isbn']+'</p></br><p style = "margin-top:-30px"> Author: '+myList['listing'][i]['author']+'</p></td>';
                    selected = myList['listing'][i]['lid']
                    output +=`</tr>`;
                    //additional expand information
                    //Need to collect data about the book
                    let book_isbn = myList['listing'][i]['isbn'];
                    let image = '';
                    let img = 'img'+i;
                    let desc = 'desc'+i;
                    console.log(img);
                    getBookFromApi(book_isbn,img,desc,i)
                    let read = 'read'+i;
                    displayMainImage(book_isbn,i);
                    /*image = getBookFromApi(book_isbn,function cb(image)
                    {
                        return image
                        
                    });*/
                    output+= '<tr id="data'+i+'" class="collapse"><td colspan="4" class="hiddenRow" ><div class="accordian-body collapse p-3"id = "data'+i+'" > <div id = "'+desc+'"style = "margin-left:50px;margin-right:50px;"><span id = "dots"+'+i+'></span></div><button class = "btn btn-info" onclick="readSettings('+i+')" style = "margin-left:50px" id="'+read+'" >Read more</button></div> </br></td></tr>';
                    //output+= '<tr id="data'+i+'" class="collapse"><td colspan="4" class="hiddenRow" "style= margin-left: 50px"><div id = "'+desc+'" > Sypnosis</div> </br><button class = "btn btn-info" onclick="readSettings('+i+')" id="'+read+'" style = "margin-left:100px">Read more</button></td></tr>';

                    //populate with image, author, description
                    
                    // populate with owner first +last name, email, contact and tele
                }
                output +='</tbody></table></div>';
                

                
                document.getElementById('displayTable').innerHTML = output;
            }
            }

        }
        let url = './database/listingsForTrade.php';
        request.open("POST",url, true);
        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        request.send("username="+username);
        //window.location.assign('database/listingsForTrade.php');
        //request.send("username=yomhanks@yahoo.com&book_id=book_id");
    }
    //myList["listing"]['+i+']["lid"],username,book_id
    function confirmTradeReq(selected){
        status = confirm('Are you sure that you want to trade?')
        console.log(status)
        if (status==true){
            createTradeReq(selected)
        }
    }
  
    function displayMainImage(isbn,i){
        var request= new XMLHttpRequest();
        let image ='';
        request.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){

                var data = JSON.parse(this.responseText).items[0].volumeInfo;
                image = data.imageLinks.thumbnail;
                let description = data.description;
                console.log(description);
                let mainImage = 'main_image'+i;
                console.log(image)
                document.getElementById(mainImage).innerHTML='<img src='+image+'style="height: 500px; margin-left:50px"  >';
                
            }
        }
        request.open("GET", `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`, true);
        request.send();
        

    }

    function getBookFromApi(isbn,img,desc,i){
        
        var request= new XMLHttpRequest();
        let image ='';
        request.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){

                var data = JSON.parse(this.responseText).items[0].volumeInfo;
                
                let description = data.description;
               
                if(description==undefined)
                {
                    document.getElementById(desc).innerHTML='No description';
                }
                else
                {
                    let dots = 'dots'+i;
                    let more = 'more'+i;
                    let read = 'read'+i;

                document.getElementById(desc).innerHTML='<h4 style =margin-bottom:-20px>Sypnosis</h4></br><p style=text-align:justify;>'+description.slice(0,300)+'<span id="'+dots+'">...</span><span id="'+more+'" style = "display: none">'+description.slice(300,description.length)+'</span></p>';
                }
            }
        }
        request.open("GET", `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`, true);
        request.send();
        
    }

    function readSettings(i) {
        var dots = document.getElementById("dots"+i);
        var moreText = document.getElementById("more"+i);
        var btnText = document.getElementById("read"+i);
        if (dots.style.display === "none") {
            dots.style.display = "inline";
            btnText.innerHTML = "Read more";
            moreText.style.display = "none";
        
        } else {
            dots.style.display = "none";
            btnText.innerHTML = "Read less";
            moreText.style.display = "inline";
            
        }
        }

    function createListing()
    {
        window.location.href = "placeHolder.html";
    }
    


    </script>
    

    
</html>

