<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="testHome2.css">
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500&display=swap" rel="stylesheet"> 
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link rel="stylesheet" href="https://mdbootstrap.com/docs/standard/data/tables/"
        target="_blank">
        <!-- CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

        <!-- jQuery and JS bundle w/ Popper.js -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

    </head>
    <body class="body1" onload = 'getData()'>
        <header class="header1">
            <a href="testHome2.html" class="logo">Re-Zero</a>
            <ul>
                <li><a href="testHome2.html">Home</a></li>
                <li><a href="#">Books</a></li>
                <li><a href="#">About</a></li>
                <li class="login"><a href="loginPage.html" >Log In</a></li>
                
            </ul>
        </header>
        

        </div>
        <div class="overlay"  >
            <div class = "container" id = 'resultStatus'></div>
            <div id = 'displayTable'></div>
            <!-- <div class="container">
                <p>Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum.</p>
            </div> -->
           
        </div>
    </body>



        <script type="text/javascript">
        window.addEventListener("scroll", function(){
            var header= document.querySelector("header");
            header.classList.toggle("sticky", window.scrollY > 0);
        })

    </script>
    <script>
        //Call to populate data on load
        //$username = $_SESSION['username'];
        //$book_id = $_POST['bookID'];// get post value from previous page
        var img = '';
        function getData(){
        username ="infinty@yahoo.com";
        book_id = 4;
        let output ='<div class = "container-sm-fluid" ><table class="table table-condensed table-responsive-sm" id = "myTable" style ="color:white">';
        var request = new XMLHttpRequest();
        request.onreadystatechange = function()
        {
            
            if(this.readyState == 4 && this.status == 200)
            {
                let myList = JSON.parse(this.responseText);
                if(myList['listing'].length==0)
                {
                    document.getElementById('resultStatus').innerHTML = '<h2>You do not have any listings!<h2>';
                }
                else
                {
                    document.getElementById('resultStatus').innerHTML = '<h2>You have '+myList['listing'].length+' listings to choose from:<h2>';
                let counter =1;
                output +='<thead><tr>';
                output+='<th scope="col"></th>';
                output+='<th scope="col">Index</th>';
                output+='<th scope="col">Title</th>';
                output+='<th scope="col">Trade book</th></tr></thead><tbody class = "panel">';
                for( var i=0;i<myList['listing'].length;i++)
                {
                    //main row of table
                    count = i+1;
                    output+='<tr  data-toggle="collapse" data-target="#demo'+i+'" data-parent="#myTable"><td class="expand-button"></td>';
                    output+='<td scope="col">#'+count+'</td>';
                    output+='<td scope="col">'+myList['listing'][i]['title']+'</td>';
                    selected = myList['listing'][i]['lid']
                    output +=`<td scope="col"><button type = "button" class = "btn bg-info" style ='color:white' onclick = "createTradeReq(${selected})">Trade</button></td></tr>`;
                    //additional expand information
                    //Need to collect data about the book
                    let book_isbn = myList['listing'][i]['isbn'];
                    let image = '';
                    let img = 'img'+i;
                    let desc = 'desc'+i;
                    console.log(img);
                    getBookFromApi(book_isbn,img,desc,i)
                    let read = 'read'+i;
                    /*image = getBookFromApi(book_isbn,function cb(image)
                    {
                        return image
                        
                    });*/
                    output+= '<tr id="demo'+i+'" class="collapse"><td colspan="2" class="hiddenRow"><div id = "'+img+'"></div> </td><td colspan="2" class="hiddenRow"><div id = "'+desc+'"> Sypnosis</div> </br><button class = "btn btn-info" onclick="readSettings('+i+')" id="'+read+'">Read more</button></td></tr>';
                    //populate with image, author, description
                    
                    // populate with owner first +last name, email, contact and tele
                }
                output +='</tbody></table></div>';
                

                
                document.getElementById('displayTable').innerHTML = output;
            }
            }

        }
        let url = 'database/listingsForTrade.php';
        request.open("POST",url, true);
        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        request.send("username="+username);
        //window.location.assign('database/listingsForTrade.php');
        //request.send("username=yomhanks@yahoo.com&book_id=book_id");
    }
    //myList["listing"]['+i+']["lid"],username,book_id
   function createTradeReq(selected)
   {
        //$username = $_SESSION['username'];
        //$book_id = $_POST['bookID'];// get post value from previous page
        let username ="infinty@yahoo.com";
        let book_id = 4;
        console.log('yes');
        var request = new XMLHttpRequest();
        
        request.onreadystatechange = function()
        {
            console.log('request created');
            if(this.readyState == 4 && this.status == 200)
            {
                
                console.log(this.responseText);
                location.reload();
            }
        }
        let url = "database/createTrade.php";
        request.open("POST",url, true);
        request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        request.send("username="+username+"&book_id="+book_id+"&my_book_id="+selected);
        
   
}

    function getBookFromApi(isbn,img,desc,i){
        console.log('called');
        var request= new XMLHttpRequest();
        let image ='';
        request.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                console.log(this.readyState);
                var data = JSON.parse(this.responseText).items[0].volumeInfo;
                image = data.imageLinks.thumbnail;
                console.log(data);
                /*if(cb) cb(image);*/
                let description = data.description;
                console.log(description);
                document.getElementById(img).innerHTML='<img src='+image+'style="height: 500px; margin-left:50px"  >';
                if(description.length ==0)
                {
                    document.getElementById(desc).innerHTML='No description';
                }
                else
                {
                    let dots = 'dots'+i;
                    let more = 'more'+i;
                    let read = 'read'+i;

                document.getElementById(desc).innerHTML='<b>Sypnosis</b></br><p style=text-align:justify;>'+description.slice(0,300)+'<span id="'+dots+'">...</span><span id="'+more+'" style = "display: none">'+description.slice(300,description.length)+'</span></p>';
                }
            }
        }
        request.open("GET", `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}`, true);
        request.send();
        
    }

    function readSettings(i) {
        var dots = document.getElementById("dots"+i);
        var moreText = document.getElementById("more"+i);
        var btnText = document.getElementById("read"+i);
        if (dots.style.display === "none") {
            dots.style.display = "inline";
            btnText.innerHTML = "Read more";
            moreText.style.display = "none";
        
        } else {
            dots.style.display = "none";
            btnText.innerHTML = "Read less";
            moreText.style.display = "inline";
            
        }
        }


    


    </script>
    

    
</html>

